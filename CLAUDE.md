# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

TBBOX Playlist Switcherは、Raspberry Pi上で動作するアプリケーションです。GPIOピンの状態を監視し、ピンの変化に応じてTBBOXのプログラムを自動的に切り替えます。

## アーキテクチャ

### コアコンポーネント

1. **GPIO監視** (`src/gpio/monitor.py`)
   - 割り込みを使用してGPIOピンの状態変化を監視
   - ピン状態が変化したときにプログラム切り替えイベントをトリガー

2. **プログラムマッピング** (`src/mapper/content_mapper.py`)
   - GPIOピン情報をTBBOXプログラム識別子（"01"-"20"）に変換
   - `config/gpio_mapping.json`のマッピング設定を使用

3. **TBBOXクライアント** (`src/tbbox/`)
   - `client.py`: TBBOXの認証とセッション管理を処理
   - `playlist.py`: TCP/IP経由でプログラム切り替えコマンドを送信

4. **設定管理** (`config/`)
   - `settings.py`: 環境変数からTBBOX接続情報を読み込み、ログインコマンドを管理
   - `gpio_mapping.json`: GPIOピン番号とTBBOXプログラムIDのマッピング定義

### アプリケーションフロー

```
GPIOピン変化 → GPIO監視 → プログラムマッパー → TBBOXクライアント → プログラム切り替え
```

## GPIO仕様（PoC版）

### ピン設定
- **初期デフォルトピン**: GPIO 18, 23, 24（`config/gpio_mapping.json`で変更可能）
- **トリガー条件**: RISING エッジ検出（LOW → HIGH）
- **プルアップ/ダウン**: プルダウン（GPIO.PUD_DOWN）
- **デバウンス時間**: 300ms（チャタリング防止）

### 動作仕様
- **1つのGPIOピン = 1つのプログラム**という単純なマッピング
- RISINGエッジ検出時に対応するプログラムを1回再生
- 複数ピンが同時にアクティブになった場合、最初に検出されたピンを優先

### マッピング例（config/gpio_mapping.json）
```json
{
  "18": "01",
  "23": "02",
  "24": "03"
}
```
- GPIO18 → プログラム"01"
- GPIO23 → プログラム"02"
- GPIO24 → プログラム"03"

### 想定する物理配線
```
[外部信号/スイッチ] → GPIOピン
                     ↓
                  GND（グランド）
```

**注意**: この仕様はPoC（概念実証）用です。実際のピン番号やトリガー条件は、クライアント要件に応じて調整してください。

## 開発コマンド

### セットアップ
```bash
# 依存パッケージのインストール
pip install -r requirements.txt

# 環境変数テンプレートのコピー
cp .env.example .env
# .envファイルを編集してTBBOX接続情報を記入
```

### 環境変数設定（.env）
以下の情報を設定してください：
- `TBBOX_IP`: TBBOXデバイスのIPアドレス
- `TBBOX_PORT`: TBBOXのポート番号（デフォルト：5503）
- `TBBOX_DEVICE_SN`: デバイスのシリアル番号
- `TBBOX_USERNAME`: ログインユーザー名（デフォルト：123456）
- `TBBOX_PASSWORD`: ログインパスワード（デフォルト：123456）

設定後、「T Card Login Protocol Calculation」ツールを使用してログインコマンドを生成し、`config/settings.py`の`LOGIN_COMMAND`に設定してください。

### 実行
```bash
# アプリケーションの起動
python main.py
```

### テスト
```bash
# 全テストの実行
pytest tests/

# 特定のテストファイルを実行
pytest tests/test_gpio_monitor.py

# カバレッジ付きで実行
pytest --cov=src tests/
```

## TBBOX通信プロトコル

### プロトコル仕様
- **通信方式**: TCP/IP
- **デフォルトポート**: 5503
- **データ形式**: 16進数コマンド

### 認証
- TB 3.0以降、すべてのコマンド送信前にログインが必須
- ログインに必要な情報：
  - デバイスSN
  - ユーザー名
  - パスワード
- これらの情報は`.env`ファイルで管理
- ログインコマンドは「T Card Login Protocol Calculation」ツールで生成し、16進数形式で`config/settings.py`の`LOGIN_COMMAND`に設定

### 主要機能コマンド

#### プログラム切り替え（01-20）
- プログラム名を"01"、"02"..."20"の形式で命名
- 各プログラムに対応する16進数コマンドが定義済み
- 例：プログラム"02"を再生
  ```
  41564f4e0200000051521e00090400000d000000000011027b226e616d65223a22303 2227d
  ```

#### 音量調整
- 0%から100%まで10%刻みで調整可能
- 各音量レベルに対応する16進数コマンドが定義済み

#### 再生制御
- **一時停止**: `41564f4e0200000051521e000c0400000000000000000702`
- **再生再開**: `41564f4e0200000051521e000a0400000000000000000502`
- **停止**: `41564f4e0200000051521e000b0400000000000000000602`

### 接続制約
- TBBOXは同時に1つのログイン接続のみサポート
- Viplex ExpressとこのアプリケーションはTBBOXに同時接続できない

## 主要技術

- **RPi.GPIO**: Raspberry Pi GPIO制御
- **socket**: TBBOXとのTCP/IP通信
- **python-dotenv**: 環境変数管理
- **pydantic**: 設定値のバリデーション

## エラーハンドリング

### TBBOX接続エラー
- 初回接続失敗時：エラーログを出力し、3秒後に再接続を試行（最大5回）
- 接続中に切断された場合：自動再接続を試行

### GPIO関連エラー
- GPIO初期化失敗：エラーログを出力してアプリケーションを終了
- 存在しないピン番号：警告ログを出力し、該当ピンをスキップ

### プログラム切り替えエラー
- 存在しないプログラムID：エラーログを出力し、切り替えをスキップ
- コマンド送信失敗：エラーログを出力し、再送信を試行（最大3回）

## 重要な注意事項

- アプリケーションはRaspberry Pi上で継続的に動作するよう設計されています
- GPIOピンのマッピングは`config/gpio_mapping.json`で定義されています
- TBBOX接続情報（IP、ポート、SN、認証情報）は`.env`ファイルで管理
- ログインコマンド（16進数）は`config/settings.py`の`LOGIN_COMMAND`で管理
- `.env`ファイルには機密情報が含まれるため、絶対にコミットしないこと（.gitignoreに追加必須）
- すべてのログ出力は`src/utils/logger.py`で管理されています
- エントリポイントは`main.py`で、すべてのコンポーネントを統合します
- TBBOXのプログラム名は必ず"01"から"20"の2桁数字形式で命名すること
